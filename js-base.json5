/*
 * Rules that should apply to both js-app and js-lib
 */

 /*
 * Deploy flow
 * ----------------------------------
 * 
 * The workflow is:
 * 1. Renovate creates the branch
 *
 * 2. Status checks added
 *    - Vercel deploys preview build (1 status check for preview deploy succes, 1 for preview comments)
 *    - Renovate waits time based on minimumReleaseAge (1 status check green once time has passed)
 *
 * 3. Renovate creates PR after the last pending status check completes (passes or fails)
 *    - NOTE(prCreation): this is what the prCreation="not-pending" option does. Makes Renovate wait to create its PR
 *
 * 4. CI starts running on the PR
 *
 * 5. Renovate auto-merges the PR if it passes CI, or waits for manual approval, etc.
 *
 * NOTE(buildAllBranches):
 *   There is a race condition where Renovate will auto-merge immediately after
 *   Vercel's status checks passed, before CircleCI had a chance to start running. This happened
 *   because Renovate only saw the passed Vercel status checks and thought CI was complete.
 * 
 *   By paying for a Github plan, we get enforced branch protection rules. We configure Github
 *   to expect the CircleCI status checks on PRs. Even if CircleCI hasn't started running yet,
 *   Github will show these as pending status checks that Renovate must wait for.
 *
 *   This allows us to configure CircleCI to only run once a PR has been created,
 *   saving significant CI time by avoiding builds on every branch push.
 *
 *   TL;DR; With paid Github and enforced status checks, CircleCI can be set to only build PRs.
 *          Without the paid Github plan and enforced status checks, the race condition means that Renovate will auto-merge before CircleCI has a chance to run.
 *          Because Renovate is configured to keep branches rebased off latest main, limiting it to only build PRs saves a ton of CI time due to rebases.
 * 
 * NOTE(runAllDay):
 *   Ideally, we would only accept updates overnight (to avoid churn while humans are working,	
 *   and to minimize PR distractions in the middle of the day).	
 * 	
 *   However the Renovate free tier [only runs every ~3-4 hours](https://docs.renovatebot.com/known-limitations/#the-mend-renovate-app-and-scheduled-jobs),	
 *   so overnight does not give enough time for updates to create a branch, wait for minimumReleaseAge, create a PR, run CI, and auto-merge	
 * 	
 *   While we're on the free tier, we'll just let Renovate run all day.	
 *   If/when upgrading to a paid plan, we can reinstate the overnight schedule, since Renovate will run every ~1 hour.
 */

{
  $schema: "https://docs.renovatebot.com/renovate-schema.json",

  rebaseWhen: "behind-base-branch", // Always run off latest main to ensure CI is run against the latest code
  branchConcurrentLimit: 5, // Allow multiple branches to run concurrently. See NOTE(buildAllBranches) for more details.
  prCreation: "not-pending", // See NOTE(prCreation). Only create PRs once minimumReleaseAge has passed
  prConcurrentLimit: 1, // Limit to 1 concurrent PR to avoid re-triggering CI for every rebase
  // See NOTE(buildAllBranches). With enforced status checks, CircleCI can be configured to only build PRs

  // Enable lockfile maintenance. The schedule and priority are configured elsewhere
  lockFileMaintenance: { enabled: true },

  platformAutomerge: true, // Use Github's auto-merge, which is faster. If not available, this will fall back to Renovate's auto-merge.
  platformCommit: true, // Use Github's API to create commits, which allows for commit signing

  packageRules: [
    {
      // Effect ecosystem packages should be grouped
      matchPackageNames: ["/^effect$/", "/^@effect\\//"],
      groupName: "Effect ecosystem",
    },
    {
      // Auth.js (formerly NextAuth) ecosystem packages should be grouped
      matchPackageNames: ["/^next-auth$/", "/^@auth\\//"],
      groupName: "Auth.js ecosystem",
    },
  ],
}
